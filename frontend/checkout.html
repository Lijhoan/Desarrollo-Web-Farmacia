<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Checkout - FarmaJoven</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Global CSS -->
    <link rel="stylesheet" href="./assets/global.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-clinic-medical me-2"></i><strong>FarmaJoven</strong>
            </a>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-credit-card me-2"></i>Finalizar Compra</h4>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <!-- Datos del Cliente -->
                            <h5 class="mb-3"><i class="fas fa-user me-2"></i>Datos del Cliente</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nombre" class="form-label">Nombre completo</label>
                                    <input type="text" class="form-control" id="nombre" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="telefono" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="telefono" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="documento" class="form-label">Documento de identidad</label>
                                    <input type="text" class="form-control" id="documento" required>
                                </div>
                            </div>

                            <!-- Dirección de Envío -->
                            <h5 class="mb-3 mt-4"><i class="fas fa-map-marker-alt me-2"></i>Dirección de Envío</h5>
                            <div class="mb-3">
                                <label for="direccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccion" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ciudad" class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="ciudad" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="codigoPostal" class="form-label">Código Postal</label>
                                    <input type="text" class="form-control" id="codigoPostal" required>
                                </div>
                            </div>

                            <!-- Método de Pago -->
                            <h5 class="mb-3 mt-4"><i class="fas fa-credit-card me-2"></i>Método de Pago</h5>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta" checked>
                                    <label class="form-check-label" for="tarjeta">
                                        <i class="fas fa-credit-card me-2"></i>Tarjeta de Crédito/Débito
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo">
                                    <label class="form-check-label" for="efectivo">
                                        <i class="fas fa-money-bill-wave me-2"></i>Pago en Efectivo (Contra entrega)
                                    </label>
                                </div>
                            </div>

                            <!-- Datos de Tarjeta (solo si se selecciona tarjeta) -->
                            <div id="datos-tarjeta">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="numeroTarjeta" class="form-label">Número de Tarjeta</label>
                                        <input type="text" class="form-control" id="numeroTarjeta" placeholder="1234 5678 9012 3456">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nombreTitular" class="form-label">Nombre del Titular</label>
                                        <input type="text" class="form-control" id="nombreTitular">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento</label>
                                        <input type="text" class="form-control" id="fechaVencimiento" placeholder="MM/AA">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Resumen del Pedido -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div id="resumen-items">
                            <!-- Items del carrito se mostrarán aquí -->
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal-checkout">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Envío:</span>
                            <span class="text-success">Gratis</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Total:</span>
                            <span id="total-checkout">$0.00</span>
                        </div>
                        
                        <button type="button" class="btn btn-success w-100 mt-3" onclick="procesarPedido()">
                            <i class="fas fa-check me-2"></i>Confirmar Pedido
                        </button>
                        
                        <a href="carrito.html" class="btn btn-outline-secondary w-100 mt-2">
                            <i class="fas fa-arrow-left me-2"></i>Volver al Carrito
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div class="modal fade" id="confirmacionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>¡Pedido Confirmado!</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>¡Gracias por tu compra!</h4>
                    <p>Tu pedido ha sido procesado exitosamente.</p>
                    <div id="datos-pedido">
                        <!-- Datos del pedido se mostrarán aquí -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="volverAInicio()">
                        <i class="fas fa-home me-2"></i>Volver al Inicio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Carrito JS -->
    <script src="./assets/carrito.js"></script>
    
    <script>
        // Mostrar/ocultar campos de tarjeta según método de pago seleccionado
        document.addEventListener('DOMContentLoaded', function() {
            const metodosPago = document.querySelectorAll('input[name="metodoPago"]');
            const datosTarjeta = document.getElementById('datos-tarjeta');
            
            metodosPago.forEach(metodo => {
                metodo.addEventListener('change', function() {
                    if (this.value === 'tarjeta') {
                        datosTarjeta.style.display = 'block';
                        // Hacer campos requeridos
                        document.getElementById('numeroTarjeta').required = true;
                        document.getElementById('nombreTitular').required = true;
                        document.getElementById('fechaVencimiento').required = true;
                        document.getElementById('cvv').required = true;
                    } else {
                        datosTarjeta.style.display = 'none';
                        // Remover requeridos
                        document.getElementById('numeroTarjeta').required = false;
                        document.getElementById('nombreTitular').required = false;
                        document.getElementById('fechaVencimiento').required = false;
                        document.getElementById('cvv').required = false;
                    }
                });
            });
            
            // Cargar resumen del pedido
            cargarResumenPedido();
        });

        async function cargarResumenPedido() {
            if (!carritoManager) {
                setTimeout(cargarResumenPedido, 100);
                return;
            }
            
            await carritoManager.cargarCarrito();
            const resumenItems = document.getElementById('resumen-items');
            const subtotalElement = document.getElementById('subtotal-checkout');
            const totalElement = document.getElementById('total-checkout');
            
            if (carritoManager.carrito.length === 0) {
                resumenItems.innerHTML = '<p class="text-muted">No hay productos en el carrito</p>';
                subtotalElement.textContent = '$0.00';
                totalElement.textContent = '$0.00';
                return;
            }
            
            resumenItems.innerHTML = carritoManager.carrito.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <div class="fw-bold">${item.nombre}</div>
                        <small class="text-muted">Cantidad: ${item.cantidad}</small>
                    </div>
                    <div class="text-end">
                        <div>$${(item.precio * item.cantidad).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
            
            const total = carritoManager.calcularTotal();
            subtotalElement.textContent = `$${total}`;
            totalElement.textContent = `$${total}`;
        }

        async function procesarPedido() {
            const form = document.getElementById('checkout-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Obtener datos del formulario
            const datosCliente = {
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                documento: document.getElementById('documento').value,
                direccion: document.getElementById('direccion').value,
                ciudad: document.getElementById('ciudad').value,
                codigoPostal: document.getElementById('codigoPostal').value
            };
            
            const metodoPago = document.querySelector('input[name="metodoPago"]:checked').value;
            let datosPago = { tipo: metodoPago };
            
            if (metodoPago === 'tarjeta') {
                datosPago = {
                    ...datosPago,
                    numeroTarjeta: document.getElementById('numeroTarjeta').value,
                    nombreTitular: document.getElementById('nombreTitular').value,
                    fechaVencimiento: document.getElementById('fechaVencimiento').value,
                    cvv: document.getElementById('cvv').value
                };
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        datosCliente,
                        metodoPago: datosPago
                    })
                });
                
                const resultado = await response.json();
                
                if (response.ok) {
                    // Mostrar modal de confirmación
                    document.getElementById('datos-pedido').innerHTML = `
                        <div class="alert alert-info">
                            <strong>Número de pedido:</strong> ${resultado.pedido.numeroPedido}<br>
                            <strong>Total:</strong> $${resultado.pedido.total.toFixed(2)}<br>
                            <strong>Estado:</strong> ${resultado.pedido.estado}
                        </div>
                    `;
                    
                    const modal = new bootstrap.Modal(document.getElementById('confirmacionModal'));
                    modal.show();
                    
                    // Actualizar carrito
                    carritoManager.carrito = [];
                    carritoManager.actualizarContadorCarrito();
                    
                } else {
                    alert('Error al procesar el pedido: ' + resultado.error);
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar el pedido. Por favor, intente nuevamente.');
            }
        }
        
        function volverAInicio() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>